<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Статья — СОПОДЧИНЕНИЕ</title>
  <link rel="stylesheet" href="css/style.css">
  <script defer src="js/app.js"></script>
  <script defer src="js/global-search.js"></script>
  <script defer src="js/parallax.js"></script>
  <script defer src="js/progress.js"></script>
  <script defer src="js/highlight.js"></script>
</head>
<body>
  <div class="progress" aria-hidden="true"><div class="progress__bar"></div></div>
  <div class="page">
    <div class="bg" style="background-image:url('assets/bg-earth.jpg')"></div>
    <img class="hero-earth hero-earth--scheme earth-img" src="assets/earth-circle.png" alt="Земля">
    <header class="header">
      <div class="container">
        <nav class="navbar" aria-label="Навигация">
          <div class="nav-group nav-left">
            <a class="pill" data-nav href="index.html">Главная</a>
            <a class="pill" data-nav href="scheme.html">Схема</a>
            <a class="pill active" data-nav href="articles.html">Статьи</a>
          </div>
          <div class="nav-center"></div>
          <div class="nav-group nav-right">
            <a class="pill" data-nav href="team.html">Команда</a>
            <a class="pill" data-nav href="reviews.html">Отзыв</a>
          </div>
        </nav>
      </div>
    </header>
    <main class="section">
      <div class="container">
        <section class="hero-box" style="margin-top:120px; background: transparent; box-shadow:none; padding:0">
          <h1 id="aTitle" class="hero-title" style="font-size:64px; margin-bottom:12px;">Загрузка…</h1>
          <p id="aDesc" class="hero-sub" style="max-width:980px; margin-bottom:12px;"></p>
          <div id="aAuthor" class="note" style="margin-top:16px; display:none;"></div>
          <div id="aMeta" class="note" style="margin-top:6px; display:none;"></div>
          <div class="kb-controls" style="gap:12px; margin-top:10px; flex-wrap:wrap;">
            <a class="btn" href="articles.html">← Ко всем статьям</a>
            <a id="parentBtn" class="btn" href="#" style="display:none;">← К родительскому уровню</a>
            <a id="nextBtn" class="btn" href="#" style="display:none;">К следующему уровню →</a>
          </div>
        </section>
        <section class="card textbox" style="margin-top:16px;" id="articleSection">
          <div id="imgWrap" style="display:none; text-align:center; margin-bottom:16px;">
            <img id="aImg" src="" alt="" style="max-width:100%; height:auto; border-radius:12px;">
          </div>
          <div id="aContent">Загружаем статью…</div>
          <div id="err" class="note" style="display:none; margin-top:12px;"></div>
        </section>
      </div>
    </main>
    <footer class="footer">
      <div class="container">
        <div style="opacity:.85">©PodleSSniy08/biology</div>
      </div>
    </footer>
  </div>
  <script>
    (function() {
      const setText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text || '';
      };
      const setHtml = (id, html) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html || '';
      };
      const showError = (message) => {
        setText('aTitle', 'Статья недоступна');
        setText('aDesc', '');
        setHtml('aContent', '');
        const err = document.getElementById('err');
        if (err) {
          err.style.display = 'block';
          err.textContent = message;
        }
      };
      const escapeHtml = (str) => str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      const renderLegacyBody = (body) => {
        const lines = (body || '').replace(/\r\n?/g, '\n').split('\n');
        const htmlParts = [];
        let listOpen = false;
        let paragraph = [];
        const closeParagraph = () => {
          if (paragraph.length) {
            htmlParts.push(`<p>${paragraph.join(' ')}</p>`);
            paragraph = [];
          }
        };
        const closeList = () => {
          if (listOpen) {
            htmlParts.push('</ul>');
            listOpen = false;
          }
        };
        lines.forEach((line) => {
          if (!line.trim()) {
            closeParagraph();
            closeList();
            return;
          }
          if (line.startsWith('- ')) {
            closeParagraph();
            if (!listOpen) {
              htmlParts.push('<ul>');
              listOpen = true;
            }
            htmlParts.push(`<li>${escapeHtml(line.slice(2).trim())}</li>`);
            return;
          }
          closeList();
          paragraph.push(escapeHtml(line.trim()));
        });
        closeParagraph();
        closeList();
        return htmlParts.join('\n');
      };
      const renderStructuredContent = (content) => {
        if (!content) return '';
        const parts = [];
        if (content.lead) {
          parts.push(`<p>${escapeHtml(content.lead)}</p>`);
        }
        (content.sections || []).forEach((section) => {
          parts.push('<div class="article-section" style="margin-top:18px;">');
          if (section.title) {
            parts.push(`<div class="kb-badge" style="display:inline-block; margin-bottom:6px;"><b>${escapeHtml(section.title)}</b></div>`);
          }
          (section.text || []).forEach((p) => {
            parts.push(`<p>${escapeHtml(p)}</p>`);
          });
          parts.push('</div>');
        });
        return parts.join('\n');
      };
      const applyNavigation = (articles, current) => {
        const parentButton = document.getElementById('parentBtn');
        const nextButton = document.getElementById('nextBtn');
        if (!parentButton || !nextButton) return;
        const parent = current.parentId ? articles.find((a) => a.id === current.parentId) : null;
        if (parent) {
          parentButton.href = `article.html?id=${encodeURIComponent(parent.id)}`;
          parentButton.style.display = 'inline-flex';
        } else {
          parentButton.style.display = 'none';
        }
        const child = articles.find((a) => a.parentId === current.id);
        if (child) {
          nextButton.href = `article.html?id=${encodeURIComponent(child.id)}`;
          nextButton.style.display = 'inline-flex';
        } else {
          nextButton.style.display = 'none';
        }
      };
      const applyImage = (article) => {
        const wrap = document.getElementById('imgWrap');
        const img = document.getElementById('aImg');
        if (!wrap || !img) return;
        if (article.image) {
          img.src = article.image;
          img.alt = article.imageAlt || article.title || 'Изображение статьи';
          wrap.style.display = 'block';
        } else {
          wrap.style.display = 'none';
          img.removeAttribute('src');
          img.removeAttribute('alt');
        }
      };
      const params = new URLSearchParams(window.location.search);
      const articleId = params.get('id');
      if (!articleId) {
        showError('Не указан идентификатор статьи. Используйте параметр id в адресе.');
        return;
      }
      fetch('data/articles.json', { cache: 'no-store' })
        .then((res) => res.json())
        .then((articles) => {
          if (!Array.isArray(articles)) {
            throw new Error('Некорректный формат данных.');
          }
          const article = articles.find((item) => item.id === articleId);
          if (!article) {
            showError('Статья не найдена. Проверьте корректность ссылки.');
            return;
          }
          document.title = `${article.title} — СОПОДЧИНЕНИЕ`;
          setText('aTitle', article.title || 'Без названия');
          setText('aDesc', article.excerpt || '');
          applyNavigation(articles, article);
          applyImage(article);
          const content = article.content
            ? renderStructuredContent(article.content)
            : renderLegacyBody(article.body || '');
          if (content) {
            setHtml('aContent', content);
          } else {
            setText('aContent', 'Для этой статьи пока нет содержимого.');
          }
        })
        .catch(() => {
          showError('Не удалось загрузить статью. Попробуйте обновить страницу позже.');
        });
    })();
  </script>
</body>
</html>
